<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ è–èª•å‹•ç‰©åŒ¿åäº¤æ›ç¦®ç‰© 3.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .snow-bg {
            background-color: #0f172a;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
        }
        .gradient-text { background-clip: text; -webkit-background-clip: text; color: transparent; background-image: linear-gradient(to right, #fbbf24, #f59e0b); }
    </style>
</head>
<body class="snow-bg min-h-screen text-slate-100 pb-20 relative">

    <!-- éŸ³æ•ˆè³‡æº -->
    <audio id="sfx-spin" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>
    <audio id="sfx-drum" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-tada" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

    <!-- é‡ç½®æŒ‰éˆ• (æ¸¬è©¦ç”¨/åˆ‡æ›èº«åˆ†ç”¨) -->
    <button onclick="logout()" class="absolute top-4 left-4 text-xs text-slate-500 hover:text-white border border-slate-600 px-2 py-1 rounded z-50">
        â†º é‡ç½®èº«åˆ†
    </button>

    <header class="text-center py-8 px-4 mt-4">
        <h1 class="text-4xl font-bold text-red-500 drop-shadow-md mb-2">ğŸ… è–èª•å‹•ç‰©ç¦®ç‰©äº¤æ›</h1>
        <p class="text-slate-400 text-sm">æ¹Šæ»¿ 5 äºº Â· æŠ½å‡ºç‰¹å¾µ Â· å…¬é–‹é…å°</p>
    </header>

    <main class="max-w-md mx-auto px-4 relative">
        
        <!-- Loading Overlay -->
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-500 mb-4"></div>
            <p class="text-white font-bold" id="loadingText">é€£ç·šä¸­...</p>
        </div>

        <!-- 1. ç™»å…¥å€ (é è¨­é¡¯ç¤º) -->
        <div id="loginSection" class="bg-white text-slate-800 rounded-xl p-6 shadow-xl border-4 border-green-700 mb-8 transform transition-all duration-500">
            <h2 class="text-xl font-bold mb-2 text-center text-green-800">ä½ æ˜¯å“ªéš»å‹•ç‰©ï¼Ÿ ğŸ¾</h2>
            <p class="text-sm text-gray-500 text-center mb-4">è«‹èª å¯¦é¸æ“‡ä½ çš„ä»£è™Ÿï¼Œå‹¿å†’ç”¨ä»–äººèº«åˆ†</p>
            
            <div class="space-y-3">
                <select id="animalSelect" class="w-full p-4 border-2 border-green-200 rounded-xl mb-4 bg-green-50 text-lg font-bold text-green-900 focus:outline-none focus:border-green-500">
                    <option value="" disabled selected>ğŸ‘‡ é»æ“Šé¸æ“‡ä½ çš„ä»£è™Ÿ</option>
                    <option value="Penguin">Penguin (ä¼éµ ğŸ§)</option>
                    <option value="Alpaca">Alpaca (ç¾Šé§ ğŸ¦™)</option>
                    <option value="Sloth">Sloth (æ¨¹æ‡¶ ğŸ¦¥)</option>
                    <option value="Owl">Owl (è²“é ­é·¹ ğŸ¦‰)</option>
                    <option value="Sea Otter">Sea Otter (æµ·çº ğŸ¦¦)</option>
                </select>
                
                <button onclick="login()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl shadow-lg transition transform active:scale-95 text-lg">
                    ç¢ºèªèº«åˆ†ä¸¦é€²å…¥
                </button>
            </div>
        </div>

        <!-- 2. æŠ½ç±¤å€ (ç™»å…¥å¾Œé¡¯ç¤º) -->
        <div id="lotterySection" class="hidden bg-white text-slate-800 rounded-xl p-6 shadow-xl border-4 border-yellow-500 mb-8 relative">
            
            <!-- é¡¯ç¤ºç•¶å‰ç™»å…¥è€… -->
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-white px-4 py-1 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">
                ç›®å‰èº«åˆ†ï¼š<span id="userBadge"></span>
            </div>

            <h2 class="text-xl font-bold mb-2 text-center text-yellow-800 mt-4">âœ¨ æŠ½å–ç¦®ç‰©ç‰¹å¾µ âœ¨</h2>
            
            <div id="lotteryIntro">
                <p class="text-sm text-center text-gray-500 mb-6">é»æ“ŠæŒ‰éˆ•ï¼Œç³»çµ±å°‡å¾ 50+ ç¨®ç‰¹å¾µä¸­<br>éš¨æ©ŸæŠ½å‡º 3 å€‹ã€‚</p>
                <button onclick="startDrawAnimation()" class="w-full bg-gradient-to-b from-yellow-400 to-yellow-600 hover:from-yellow-500 hover:to-yellow-700 text-white font-bold py-4 rounded-xl shadow-lg text-lg transition transform hover:scale-105 border-b-4 border-yellow-800">
                    ğŸ° å•Ÿå‹•æ‹‰éœ¸æ©Ÿ
                </button>
            </div>

            <!-- å¡ç‰‡å€ -->
            <div id="cardsContainer" class="grid grid-cols-1 gap-3 hidden mt-4"></div>

            <button id="submitBtn" onclick="submitFeatures()" class="hidden w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed transition">
                ğŸ ç¢ºèªä¸¦é€å‡ºé¡˜æœ›
            </button>
        </div>

        <!-- 3. å·²æäº¤ç‹€æ…‹ -->
        <div id="submittedState" class="hidden bg-green-100 text-green-900 rounded-xl p-6 shadow-lg border-2 border-green-500 mb-8 text-center relative">
             <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-1 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">
                ç›®å‰èº«åˆ†ï¼š<span id="submittedUserBadge"></span>
            </div>
            <h3 class="text-2xl font-bold mb-2 mt-2">ğŸ„ é¡˜æœ›å·²æ›ä¸Šæ¨¹æ¢¢ï¼</h3>
            <p id="mySubmittedFeatures" class="font-bold text-lg text-red-600 my-3"></p>
            <p class="text-sm">è«‹ç­‰å¾…å…¶ä»–äººå®Œæˆï¼Œå†é€²è¡Œé…å°ã€‚</p>
        </div>

        <!-- 4. è¨±é¡˜ç‰† (å³æ™‚æ›´æ–°) -->
        <div id="wallSection" class="bg-slate-800 bg-opacity-90 backdrop-blur rounded-xl p-5 shadow-xl border border-slate-600 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-yellow-400">ğŸ“‹ è¨±é¡˜é€²åº¦ (<span id="progressCount">0</span>/5)</h2>
                <div class="animate-pulse h-2 w-2 bg-green-500 rounded-full"></div>
            </div>
            <div id="wallGrid" class="space-y-3"></div>
        </div>

        <!-- 5. é…å°å€ (æ¢ä»¶è§¸ç™¼) -->
        <div id="pairingSection" class="bg-red-900 bg-opacity-90 backdrop-blur rounded-xl p-6 shadow-2xl border-2 border-red-500 text-center">
            <h2 class="text-2xl font-bold text-white mb-4">ğŸ”— æœ€çµ‚é…å°</h2>
            
            <div id="pairingWaiting" class="py-4">
                <p class="text-red-200 mb-2">ç­‰å¾…æ‰€æœ‰äººæäº¤ç‰¹å¾µå¾Œé–‹å•Ÿ...</p>
                <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                    <div id="progressBar" class="bg-yellow-400 h-full w-0 transition-all duration-1000"></div>
                </div>
            </div>

            <div id="pairingAction" class="hidden py-4">
                <p class="text-yellow-300 font-bold mb-4 text-lg animate-bounce">æ‰€æœ‰äººéƒ½æº–å‚™å¥½äº†ï¼</p>
                <button onclick="generatePairing()" class="w-full bg-gradient-to-r from-yellow-500 to-red-600 text-white font-bold py-4 rounded-xl shadow-xl text-xl transition transform hover:scale-105 active:scale-95">
                    ğŸš€ å•Ÿå‹•é…å°è¼ªç›¤
                </button>
            </div>

            <div id="pairingResult" class="hidden space-y-3 text-left mt-4">
                <!-- é…å°çµæœ -->
            </div>
        </div>

    </main>

    <script>
        // ============================================
        // âš ï¸ è«‹å¡«å¯«æ­£ç¢ºçš„ GAS URL (ä¸éœ€è¦é‡æ–°éƒ¨ç½² GASï¼Œåªè¦æ›å‰ç«¯å³å¯)
        const API_URL = 'https://script.google.com/macros/s/AKfycbzq9VELc16iIDjvOvOPkcrvvBI6Wvz53KrnHIZJL5F-ivV6cvSP-C_PH8umKnaGcNBB5A/exec'; 
        // ============================================

        const ANIMAL_NAMES = {
            'Penguin': 'ä¼éµ ğŸ§',
            'Alpaca': 'ç¾Šé§ ğŸ¦™',
            'Sloth': 'æ¨¹æ‡¶ ğŸ¦¥',
            'Owl': 'è²“é ­é·¹ ğŸ¦‰',
            'Sea Otter': 'æµ·çº ğŸ¦¦'
        };

        // æ“´å……å¾Œçš„ç‰¹å¾µè³‡æ–™åº« (ä¿®æ­£ç‰ˆ)
        const FEATURE_DB = {
            shapes: [
                "é•·æ¢ç‹€çš„", "åœ“åœ“çš„", "æ–¹å½¢çš„", "ä¸è¦å‰‡å½¢ç‹€", "å½æ›²çš„",
                "ä¸‰è§’å½¢çš„", "æ˜Ÿæ˜Ÿå½¢ç‹€çš„", "å‹•ç‰©é€ å‹çš„", "æ‰å¹³çš„", "æœ‰æ´æ´çš„", "å·¨å¤§çš„", "è¿·ä½ çš„", "æ„›å¿ƒå½¢ç‹€çš„"
            ],
            colors: [
                "ç´…è‰²çš„", "é‡‘è‰²çš„", "é€æ˜çš„", "é»‘è‰²çš„", "éŠ€è‰²çš„", "éœ§é¢çš„",
                "å½©è™¹è‰²çš„", "ç¶ è‰²çš„", "æœ¨é ­è‰²çš„", "ç²‰å«©è‰²ç³»çš„", "æ¼¸å±¤è‰²çš„", "ç´”ç™½è‰²çš„", "äº”é¡å…­è‰²çš„"
            ],
            functions: [
                "å¯ä»¥åƒçš„", "å¯ä»¥å–çš„", "æ‰‹æŒå¼çš„", "å¯ç©¿æˆ´çš„", "å¯ç©è€çš„", "èˆ‡æ¸…æ½”ç›¸é—œçš„",
                "æœƒå‹•çš„", "å¯ä»¥å……é›»çš„", "èˆ’å£“çš„", "ç´”è£é£¾çš„", "èˆ‡éŸ³æ¨‚æœ‰é—œçš„", "è®“ç”Ÿæ´»è®Šæ–¹ä¾¿çš„", "è¾¦å…¬å®¤å¯ç”¨çš„", "å¯ä»¥æŠ±è‘—ç¡çš„", "å…·æ”¶ç´åŠŸèƒ½çš„", "æ¥è§¸è‚Œè†šçš„"
            ],
            states: [
                "é¦™é¦™çš„", "å†°å†·çš„", "æœƒç™¼å…‰çš„", "æœƒç™¼å‡ºè²éŸ³çš„", "æ¯›èŒ¸èŒ¸çš„", "é¹¹é¹¹çš„", "ç”œç”œçš„", "è¾£è¾£çš„", "ç†±ç†±çš„", "æ¶²é«”ç‹€çš„",
                "é˜²æ°´çš„", "ç£å¸çš„", "è»Ÿè»Ÿçš„", "ç¡¬é‚¦é‚¦çš„", "å¾ˆæœ‰é‡é‡çš„", "æ˜“ç¢çš„", "å¾©å¤é¢¨æ ¼çš„", "æ»‘æºœæºœçš„", "å¯æ„›çš„"
            ]
        };

        let currentUser = localStorage.getItem('animalUser');
        let myFeatures = [];
        let finalSelection = [];
        let isDrawing = false;
        let globalInterval = null;

        // --- åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            if (currentUser) {
                showLoggedInView();
            } else {
                showLoginView();
            }
            
            fetchData(); 
            globalInterval = setInterval(fetchData, 3000);
        });

        function showLoginView() {
            document.getElementById('loginSection').classList.remove('hidden');
            document.getElementById('lotterySection').classList.add('hidden');
            document.getElementById('submittedState').classList.add('hidden');
        }

        function showLoggedInView() {
            document.getElementById('loginSection').classList.add('hidden');
            // æ›´æ–° Badge
            const zhName = ANIMAL_NAMES[currentUser];
            document.getElementById('userBadge').innerText = zhName;
            document.getElementById('submittedUserBadge').innerText = zhName;
        }

        // --- ç™»å…¥ ---
        function login() {
            const select = document.getElementById('animalSelect');
            if (!select.value) return alert('è«‹é¸æ“‡ä¸€å€‹å‹•ç‰©ä»£è™Ÿï¼');
            
            currentUser = select.value;
            localStorage.setItem('animalUser', currentUser);
            
            showLoggedInView();
            
            // ç™»å…¥å¾Œé è¨­é¡¯ç¤ºæŠ½ç±¤å€ (è‹¥å·²æäº¤ï¼ŒfetchData æœƒè‡ªå‹•åˆ‡æ›åˆ° submittedState)
            document.getElementById('lotterySection').classList.remove('hidden');
            fetchData();
        }

        // --- ç™»å‡º (é‡ç½®) ---
        function logout() {
            if(confirm('ç¢ºå®šè¦é‡ç½®èº«åˆ†å—ï¼Ÿ(é€™ä¸æœƒåˆªé™¤å·²é€å‡ºçš„é¡˜æœ›ï¼Œåªæ˜¯æ¸…é™¤ç€è¦½å™¨ç´€éŒ„)')) {
                localStorage.removeItem('animalUser');
                currentUser = null;
                location.reload();
            }
        }

        // --- éŸ³æ•ˆ helper ---
        function playSfx(id) {
            const audio = document.getElementById(id);
            if(audio) {
                audio.currentTime = 0;
                audio.play().catch(e => console.log('Audio play failed'));
            }
        }

        // --- æŠ½ç±¤å‹•ç•« (é‚è¼¯ä¿®æ­£ï¼šç¢ºä¿é¡åˆ¥ä¸é‡è¤‡) ---
        function startDrawAnimation() {
            if (isDrawing) return;
            isDrawing = true;
            document.getElementById('lotteryIntro').classList.add('hidden');
            document.getElementById('cardsContainer').classList.remove('hidden');
            
            playSfx('sfx-spin');

            // 1. æº–å‚™æ‰€æœ‰ç‰¹å¾µç”¨æ–¼ã€Œè·‘é¦¬ç‡ˆå‹•ç•«ã€ (è¦–è¦ºæ•ˆæœç”¨ï¼Œé‚„æ˜¯éš¨æ©Ÿè·³å‹•)
            const allFeaturesForAnim = [
                ...FEATURE_DB.shapes, ...FEATURE_DB.colors, 
                ...FEATURE_DB.functions, ...FEATURE_DB.states
            ];

            // 2. æ±ºå®šã€Œæœ€çµ‚çµæœã€ (æ ¸å¿ƒé‚è¼¯ä¿®æ­£ï¼šé¡åˆ¥ä¸é‡è¤‡)
            // æ­¥é©Ÿ A: å–å¾—æ‰€æœ‰é¡åˆ¥åç¨± ['shapes', 'colors', 'functions', 'states']
            const categories = Object.keys(FEATURE_DB);
            
            // æ­¥é©Ÿ B: æ´—ç‰Œé¡åˆ¥ï¼Œä¸¦å–å‡ºå‰ 3 å€‹ (ä¾‹å¦‚å–å‡ºï¼š['colors', 'shapes', 'states'])
            const selectedCategories = categories.sort(() => 0.5 - Math.random()).slice(0, 3);
            
            // æ­¥é©Ÿ C: å¾é€™ 3 å€‹é¡åˆ¥ä¸­ï¼Œå„æŠ½å‡º 1 å€‹ç‰¹å¾µ
            const finalDraw = selectedCategories.map(cat => {
                const list = FEATURE_DB[cat];
                const randomIndex = Math.floor(Math.random() * list.length);
                return list[randomIndex];
            });

            myFeatures = finalDraw;
            finalSelection = [...finalDraw];

            // 3. å»ºç«‹ 3 å€‹å¡ç‰‡æ’æ§½
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            for(let i=0; i<3; i++) {
                const card = document.createElement('div');
                card.id = `slot-${i}`;
                card.className = "bg-gray-100 p-4 rounded-lg border-2 border-gray-300 text-center font-bold text-gray-400 text-xl";
                card.innerText = "???";
                container.appendChild(card);
            }

            // 4. åŸ·è¡Œå‹•ç•« (è¦–è¦ºä¸Šé‚„æ˜¯éš¨æ©Ÿè·³å‹•ï¼Œå¢åŠ ç·Šå¼µæ„Ÿ)
            let steps = 0;
            const maxSteps = 20;
            const interval = setInterval(() => {
                steps++;
                for(let i=0; i<3; i++) {
                    // å‹•ç•«éç¨‹ä¸­éš¨æ©Ÿé¡¯ç¤ºä»»ä½•ç‰¹å¾µ
                    const randomText = allFeaturesForAnim[Math.floor(Math.random() * allFeaturesForAnim.length)];
                    document.getElementById(`slot-${i}`).innerText = randomText;
                }
                
                if (steps >= maxSteps) {
                    clearInterval(interval);
                    revealFinalCards(); // åœæ­¢æ™‚é¡¯ç¤ºå‰›å‰›ç®—å¥½çš„ finalDraw
                }
            }, 100);
        }
        
        function revealFinalCards() {
            playSfx('sfx-win');
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            renderCards();
            document.getElementById('submitBtn').classList.remove('hidden');
            
            const tip = document.createElement('p');
            tip.className = "text-center text-red-600 font-bold mt-2 animate-bounce";
            tip.innerText = "ğŸ‘‡ è«‹é»æ“Šã€Œåˆªé™¤ã€å»æ‰ 1 å€‹ç‰¹å¾µ";
            document.getElementById('cardsContainer').prepend(tip);
        }

        function renderCards() {
            const container = document.getElementById('cardsContainer');
            const tip = container.querySelector('p');
            container.innerHTML = '';
            if(tip) container.appendChild(tip);

            myFeatures.forEach((feature) => {
                const isDeleted = !finalSelection.includes(feature);
                const card = document.createElement('div');
                card.className = `p-4 rounded-lg border-2 flex justify-between items-center transition duration-300 ${isDeleted ? 'bg-gray-200 border-gray-300 opacity-60' : 'bg-red-50 border-red-300 scale-100'}`;
                
                const text = document.createElement('span');
                text.className = `font-bold text-lg ${isDeleted ? 'line-through text-gray-500' : 'text-red-700'}`;
                text.innerText = feature;

                const btn = document.createElement('button');
                btn.className = `text-sm px-3 py-1 rounded transition ${isDeleted ? 'bg-gray-500 text-white' : 'bg-red-500 text-white hover:bg-red-600 shadow'}`;
                btn.innerText = isDeleted ? "å¾©åŸ" : "åˆªé™¤ ğŸ—‘ï¸";
                btn.onclick = () => toggleFeature(feature);

                card.appendChild(text);
                card.appendChild(btn);
                container.appendChild(card);
            });
            updateSubmitBtn();
        }

        function toggleFeature(feature) {
            if (finalSelection.includes(feature)) {
                if (finalSelection.length <= 2) finalSelection = finalSelection.filter(f => f !== feature);
                else finalSelection = finalSelection.filter(f => f !== feature);
            } else {
                if (finalSelection.length < 3) finalSelection.push(feature);
            }
            renderCards();
        }

        function updateSubmitBtn() {
            const btn = document.getElementById('submitBtn');
            if (finalSelection.length === 2) {
                btn.disabled = false;
                btn.innerText = "ğŸ ç¢ºèªä¸¦é€å‡ºé¡˜æœ›";
                btn.className = "w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:scale-105";
            } else {
                btn.disabled = true;
                btn.innerText = `è«‹ä¿ç•™ 2 å€‹ (ç›®å‰ ${finalSelection.length} å€‹)`;
                btn.className = "w-full mt-6 bg-gray-400 text-white font-bold py-3 rounded-lg cursor-not-allowed";
            }
        }

        // --- API æäº¤ ---
        function submitFeatures() {
            document.getElementById('loading').classList.remove('hidden');
            const payload = {
                action: 'submit_feature',
                nickname: currentUser,
                feature1: finalSelection[0],
                feature2: finalSelection[1]
            };

            fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                alert('è¨±é¡˜æˆåŠŸï¼');
                fetchData();
            });
        }

        function generatePairing() {
            if(!confirm("ç¢ºå®šè¦é€²è¡Œæœ€çµ‚é…å°å—ï¼Ÿé€™å°‡å…¬é–‹çµ¦æ‰€æœ‰äººçœ‹ï¼")) return;
            
            playSfx('sfx-drum');
            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('loadingText').innerText = "æ­£åœ¨å‘½é‹é…å°ä¸­...";

            fetch(API_URL, { 
                method: 'POST', 
                body: JSON.stringify({ action: 'generate_pair' }) 
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                if(data.status === 'success' || data.status === 'already_paired') {
                    fetchData();
                } else {
                    alert('é…å°å¤±æ•—ï¼š' + data.status);
                }
            });
        }

        // --- è³‡æ–™è®€å– ---
        // --- è³‡æ–™è®€å–èˆ‡ç‹€æ…‹é¡¯ç¤º (æ ¸å¿ƒé‚è¼¯æ›´æ–°) ---
        function fetchData() {
            fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                // 1. æ›´æ–°è¨±é¡˜ç‰†
                renderWall(data.submissions);
                document.getElementById('progressCount').innerText = data.submissionCount;
                
                // 2. ä½¿ç”¨è€…ç‹€æ…‹æ›´æ–° (å¦‚æœå·²ç™»å…¥ä¸”å·²æäº¤)
                if (currentUser && data.submissions[currentUser]) {
                    document.getElementById('lotterySection').classList.add('hidden');
                    document.getElementById('submittedState').classList.remove('hidden');
                    document.getElementById('mySubmittedFeatures').innerText = 
                        `${data.submissions[currentUser][0]} ï¼‹ ${data.submissions[currentUser][1]}`;
                }

                // 3. åš´æ ¼çš„éšæ®µæ§åˆ¶é‚è¼¯
                const pWaiting = document.getElementById('pairingWaiting'); // ç­‰å¾…æ¢
                const pAction = document.getElementById('pairingAction');   // é…å°æŒ‰éˆ•
                const pResult = document.getElementById('pairingResult');   // é…å°çµæœ
                const pBar = document.getElementById('progressBar');        // é€²åº¦æ¢é•·åº¦

                // æ›´æ–°é€²åº¦æ¢è¦–è¦º
                const pct = Math.min((data.submissionCount / 5) * 100, 100);
                pBar.style.width = `${pct}%`;

                // ç‹€æ…‹æ©Ÿåˆ¤æ–·
                if (data.isPaired) {
                    // éšæ®µ C: éŠæˆ²çµæŸï¼Œå·²é…å°
                    pWaiting.classList.add('hidden');
                    pAction.classList.add('hidden');
                    
                    // åªåœ¨ç¬¬ä¸€æ¬¡åˆ‡æ›åˆ°é¡¯ç¤ºæ™‚æ’­æ”¾ç‰¹æ•ˆ
                    if (pResult.classList.contains('hidden')) {
                        playSfx('sfx-tada');
                        confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                    }
                    pResult.classList.remove('hidden');
                    renderPairingResult(data.pairings);
                    
                } else if (data.submissionCount >= 5) {
                    // éšæ®µ B: äººæ•¸å·²æ»¿ï¼Œç­‰å¾…æŸäººæŒ‰ä¸‹æŒ‰éˆ•
                    pWaiting.classList.add('hidden');
                    pAction.classList.remove('hidden'); // é¡¯ç¤ºæŒ‰éˆ•
                    pResult.classList.add('hidden');    // ç¢ºä¿çµæœæ˜¯éš±è—çš„
                    
                } else {
                    // éšæ®µ A: äººæ•¸æœªæ»¿ï¼Œç­‰å¾…ä¸­
                    pWaiting.classList.remove('hidden');
                    pAction.classList.add('hidden');
                    pResult.classList.add('hidden'); // ç¢ºä¿çµæœæ˜¯éš±è—çš„
                }
            })
            .catch(err => console.error('Error:', err));
        }
        
        function renderWall(submissions) {
            const grid = document.getElementById('wallGrid');
            grid.innerHTML = '';
            const fixedOrder = ['Penguin', 'Alpaca', 'Sloth', 'Owl', 'Sea Otter'];

            fixedOrder.forEach(engName => {
                const zhName = ANIMAL_NAMES[engName];
                const row = document.createElement('div');
                row.className = "bg-slate-700 bg-opacity-50 rounded p-3 flex items-center justify-between border border-slate-600";
                
                const isMe = (engName === currentUser);
                const nameDiv = document.createElement('div');
                nameDiv.innerHTML = `<span class="${isMe ? 'text-yellow-400 font-bold' : 'text-slate-200'}">${zhName}</span>`;

                const contentDiv = document.createElement('div');
                contentDiv.className = "flex gap-2";

                if (submissions[engName]) {
                    const f1 = document.createElement('span');
                    f1.className = "bg-red-600 text-white text-xs px-2 py-1 rounded shadow";
                    f1.innerText = submissions[engName][0];
                    const f2 = document.createElement('span');
                    f2.className = "bg-green-600 text-white text-xs px-2 py-1 rounded shadow";
                    f2.innerText = submissions[engName][1];
                    contentDiv.appendChild(f1);
                    contentDiv.appendChild(f2);
                } else {
                    contentDiv.innerHTML = `<span class="text-slate-500 text-xs animate-pulse">æ€è€ƒä¸­...</span>`;
                }
                row.appendChild(nameDiv);
                row.appendChild(contentDiv);
                grid.appendChild(row);
            });
        }

        function renderPairingResult(pairings) {
            const container = document.getElementById('pairingResult');
            container.innerHTML = '';

            pairings.forEach((pair, index) => {
                const isMyMission = (pair.from === currentUser);
                let bgClass = "bg-black bg-opacity-40 border-slate-700";
                if(isMyMission) bgClass = "bg-yellow-900 bg-opacity-60 border-yellow-500 transform scale-105";

                const div = document.createElement('div');
                div.className = `p-3 rounded border flex items-center justify-between ${bgClass}`;
                
                const fromName = ANIMAL_NAMES[pair.from];
                const toName = ANIMAL_NAMES[pair.to];

                div.innerHTML = `
                    <div class="font-bold text-slate-300 w-5/12 text-right ${pair.from===currentUser?'text-yellow-300':''}">${fromName}</div>
                    <div class="w-2/12 text-center text-red-500 text-xl">âœ</div>
                    <div class="font-bold text-slate-300 w-5/12 text-left ${pair.to===currentUser?'text-yellow-300':''}">${toName}</div>
                `;

                div.style.opacity = '0';
                div.style.animation = `fadeIn 0.5s forwards ${index * 0.3}s`;
                container.appendChild(div);
            });
            
            if (currentUser) {
                const myTarget = pairings.find(p => p.from === currentUser);
                if(myTarget) {
                    const targetName = ANIMAL_NAMES[myTarget.to];
                    const msg = document.createElement('div');
                    msg.className = "mt-4 bg-yellow-100 text-yellow-800 p-3 rounded font-bold text-center animate-bounce";
                    msg.innerHTML = `ğŸ¯ ä½ çš„ä»»å‹™ï¼šè²·ç¦®ç‰©çµ¦ <span class="text-red-600 text-xl">${targetName}</span>ï¼`;
                    container.appendChild(msg);
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</body>
</html>
