<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ„ 2025è–èª•ç¥ç§˜äº¤æ›ç¦®ç‰©</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .hidden { display: none !important; }
        .snow-bg {
            background-color: #0f172a;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
        }
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        .animate-bounce-slow {
            animation: bounce-slow 2s infinite;
        }
    </style>
</head>
<body class="snow-bg min-h-screen text-slate-100 pb-20 relative">

    <!-- éŸ³æ•ˆå€ (å·²åŠ å…¥ ?v=final_fix å¼·åˆ¶ç€è¦½å™¨é‡æ–°ä¸‹è¼‰ï¼Œç¢ºä¿éŸ³æ•ˆä¸åŒ) -->
    
    <!-- 1. é¼“è² (é•·ä¸€é»çš„æ»¾å¥) -->
    <audio id="sfx-drum" src="https://actions.google.com/sounds/v1/cartoon/cartoon_boing.ogg" preload="auto"></audio>
    <!-- å‚™ç”¨é¼“è²ï¼šå¦‚æœä¸Šé¢å¤ªå¡é€šï¼Œé€™é‚Šç”¨ä»£ç¢¼åˆ‡æ›ï¼Œå…ˆç”¨é€™å€‹æ›´æœ‰å¼µåŠ›çš„ -->
    <audio id="sfx-drum-roll" src="https://cdn.pixabay.com/audio/2022/03/10/audio_822cb33780.mp3?v=final_fix" preload="auto"></audio>

    <!-- 2. æ‹‰éœ¸è½‰å‹•è² (å¿«é€Ÿæ»´ç­”è²) -->
    <audio id="sfx-spin" src="https://cdn.pixabay.com/audio/2022/03/24/audio_33a763c0f6.mp3?v=final_fix" preload="auto"></audio>
    
    <!-- 3. æˆåŠŸ/æ­æ›‰ (éŸ¿äº®è™Ÿè§’) -->
    <audio id="sfx-tada" src="https://cdn.pixabay.com/audio/2021/08/04/audio_12b0c7443c.mp3?v=final_fix" preload="auto"></audio>
    
    <!-- 4. é…å°é‹ç®—ä¸­ (é­”æ³•é¢¨éˆ´) -->
    <audio id="sfx-magic" src="https://cdn.pixabay.com/audio/2022/03/19/audio_97af9b0496.mp3?v=final_fix" preload="auto"></audio>
    
    <!-- 5. æŒ‰éˆ•é»æ“Š (æ¸…è„†çš„æ³¢ä¸€è²) -->
    <audio id="sfx-click" src="https://cdn.pixabay.com/audio/2022/03/15/audio_736881c621.mp3?v=final_fix" preload="auto"></audio>

    <button onclick="logout()" class="absolute top-4 left-4 text-xs text-slate-500 hover:text-white border border-slate-600 px-2 py-1 rounded z-50">ğŸ”’ é‡ç½®èº«åˆ†</button>

    <header class="text-center py-8 px-4 mt-4">
        <h1 class="text-4xl font-bold text-red-500 drop-shadow-md mb-2">ğŸ… 2025è–èª•ç¥ç§˜äº¤æ›ç¦®ç‰©</h1>
        <p class="text-slate-400 text-sm">æŠ½å–è§’è‰² Â· åŒ¿åè¨±é¡˜ Â· å‘½é‹é…å°</p>
    </header>

    <main class="max-w-md mx-auto px-4 relative">
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-500 mb-4"></div>
            <p class="text-white font-bold" id="loadingText">è™•ç†ä¸­...</p>
        </div>

        <!-- 0. æŠ½å–è§’è‰²å€ -->
        <div id="drawRoleSection" class="hidden bg-white text-slate-800 rounded-xl p-6 shadow-xl border-4 border-purple-600 mb-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-purple-50 opacity-50 pointer-events-none"></div>
            <h2 class="text-2xl font-bold mb-4 text-center text-purple-900 relative z-10">ğŸ­ ä½ çš„ç¥ç§˜èº«åˆ†æ˜¯ï¼Ÿ</h2>
            <div class="text-center py-4 relative z-10">
                <div class="text-6xl mb-6 animate-bounce-slow">â“</div>
                <p class="text-gray-500 mb-6 text-sm">é»æ“ŠæŒ‰éˆ•ï¼Œå¾å‘½é‹ç‰Œå †ä¸­<br>æŠ½å–ä¸€å¼µå°ˆå±¬æ–¼ä½ çš„å‹•ç‰©å¡ç‰Œã€‚</p>
                <button id="btnDrawRole" onclick="drawRole()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg text-lg transform transition hover:scale-105 active:scale-95">
                    ğŸ´ æŠ½å–æˆ‘çš„è§’è‰²
                </button>
            </div>
        </div>

        <!-- 0.5 è§’è‰²æ­æ›‰å‹•ç•«å€ -->
        <div id="roleRevealSection" class="hidden fixed inset-0 z-40 bg-slate-900 flex flex-col items-center justify-center text-center px-4">
            <h2 id="revealTitle" class="text-white text-2xl font-bold mb-4 animate-pulse">ğŸ² å‘½é‹å®‰æ’ä¸­...</h2>
            <div id="revealCard" class="bg-white text-slate-900 p-8 rounded-2xl shadow-2xl transform transition-all duration-500 w-64 h-80 flex flex-col items-center justify-center border-4 border-purple-400">
                <div id="cardContent"><div class="text-6xl mb-4 animate-spin">ğŸƒ</div></div>
            </div>
            <button onclick="confirmRole()" class="mt-10 bg-yellow-500 hover:bg-yellow-600 text-white px-10 py-3 rounded-full font-bold shadow-lg hidden animate-bounce" id="enterGameBtn">
                é€²å…¥éŠæˆ² âœ
            </button>
        </div>

        <!-- 1.5 çœŸå¯¦å§“åå¡«å¯« -->
        <div id="profileSection" class="hidden bg-white text-slate-800 rounded-xl p-6 shadow-xl border-4 border-blue-600 mb-8">
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">
                èº«åˆ†ï¼š<span class="userBadgeText"></span>
            </div>
            <h2 class="text-xl font-bold mb-2 text-center text-blue-800 mt-4">ğŸ“› å¡«å¯«çœŸå¯¦å§“å</h2>
            <p class="text-sm text-gray-500 text-center mb-4">è®“æŠ½åˆ°ä½ çš„äººçŸ¥é“æ˜¯èª°ï¼</p>
            <div class="space-y-3">
                <input type="text" id="inputName" placeholder="è«‹è¼¸å…¥ä½ çš„çœŸå¯¦å§“å" class="w-full p-4 border-2 border-blue-200 rounded-xl text-lg text-center font-bold">
                <button id="btnSubmitProfile" onclick="submitProfile()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-lg">ç¢ºèªå„²å­˜ & ä¸‹ä¸€æ­¥</button>
            </div>
        </div>

        <!-- 2. æŠ½ç±¤å€ -->
        <div id="lotterySection" class="hidden bg-white text-slate-800 rounded-xl p-6 shadow-xl border-4 border-yellow-500 mb-8 relative">
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-white px-4 py-1 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">
                èº«åˆ†ï¼š<span class="userBadgeText"></span>
            </div>
            <h2 class="text-xl font-bold mb-2 text-center text-yellow-800 mt-4">âœ¨ æŠ½å–ç¦®ç‰©ç‰¹å¾µ âœ¨</h2>
            <div id="lotteryIntro">
                <p class="text-sm text-center text-gray-500 mb-6">ç³»çµ±å°‡å¾è³‡æ–™åº«éš¨æ©ŸæŠ½å‡º 3 å€‹ç‰¹å¾µã€‚</p>
                <button onclick="startDrawAnimation()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-xl shadow-lg text-lg">ğŸ° å•Ÿå‹•æ‹‰éœ¸æ©Ÿ</button>
            </div>
            <div id="cardsContainer" class="grid grid-cols-1 gap-3 hidden mt-4"></div>
            <button id="submitBtn" onclick="submitFeatures()" class="hidden w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-lg disabled:bg-gray-400">ğŸ ç¢ºèªä¸¦é€å‡ºé¡˜æœ›</button>
        </div>

        <!-- 3. å·²æäº¤ç‹€æ…‹ -->
        <div id="submittedState" class="hidden bg-green-100 text-green-900 rounded-xl p-6 shadow-lg border-2 border-green-500 mb-8 text-center relative">
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-green-600 text-white px-4 py-1 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">
                èº«åˆ†ï¼š<span class="userBadgeText"></span>
            </div>
            <h3 class="text-2xl font-bold mb-2 mt-4">ğŸ„ é¡˜æœ›å·²æ›ä¸Šæ¨¹æ¢¢ï¼</h3>
            <p id="mySubmittedFeatures" class="font-bold text-lg text-red-600 my-3"></p>
            <p class="text-sm text-gray-600">çœŸå¯¦å§“åï¼š<span id="mySubmittedName" class="font-bold"></span></p>
        </div>

        <!-- 4. è¨±é¡˜ç‰† -->
        <div id="wallSection" class="hidden bg-slate-800 bg-opacity-90 backdrop-blur rounded-xl p-5 shadow-xl border border-slate-600 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold text-yellow-400">ğŸ“‹ è¨±é¡˜é€²åº¦ (<span id="progressCount">0</span>/5)</h2>
                <div class="animate-pulse h-2 w-2 bg-green-500 rounded-full"></div>
            </div>
            <div id="wallGrid" class="space-y-3"></div>
        </div>

        <!-- 5. é…å°å€ -->
        <div id="pairingSection" class="bg-red-900 bg-opacity-90 backdrop-blur rounded-xl p-6 shadow-2xl border-2 border-red-500 text-center">
            <h2 class="text-2xl font-bold text-white mb-4">ğŸ”— æœ€çµ‚é…å°</h2>
            
            <div id="pairingWaiting" class="py-4">
                <p class="text-red-200 mb-2">ç­‰å¾…æ‰€æœ‰äººæäº¤ç‰¹å¾µå¾Œé–‹å•Ÿ...</p>
                <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden"><div id="progressBar" class="bg-yellow-400 h-full w-0 transition-all duration-1000"></div></div>
            </div>
            
            <div id="pairingAction" class="hidden py-4">
                <p class="text-yellow-300 font-bold mb-4 text-lg animate-bounce">æ‰€æœ‰äººéƒ½æº–å‚™å¥½äº†ï¼</p>
                <button onclick="startPairingProcess()" class="w-full bg-gradient-to-r from-yellow-500 to-red-600 text-white font-bold py-4 rounded-xl shadow-xl text-xl hover:scale-105 transition transform">
                    ğŸš€ å•Ÿå‹•é…å°è¼ªç›¤
                </button>
            </div>
            
            <div id="pairingResult" class="hidden space-y-3 text-left mt-4"></div>
        </div>

        <!-- 6. é…å°ä¸­å…¨è¢å¹•å‹•ç•« -->
        <div id="pairingOverlay" class="hidden fixed inset-0 z-50 bg-black bg-opacity-90 flex flex-col items-center justify-center">
            <div class="text-6xl mb-6 animate-spin">ğŸ¡</div>
            <h2 class="text-yellow-400 text-3xl font-bold mb-4 animate-pulse">è–èª•è€äººé…å°ä¸­...</h2>
            <div id="pairingShuffleText" class="text-white text-xl font-bold">ä¼éµ âœ â“</div>
        </div>

    </main>

    <script>
        // âš ï¸ ä½ çš„ GAS ç¶²å€ (ç¶­æŒä¸è®Š)
        const API_URL = 'https://script.google.com/macros/s/AKfycbzq9VELc16iIDjvOvOPkcrvvBI6Wvz53KrnHIZJL5F-ivV6cvSP-C_PH8umKnaGcNBB5A/exec';

        const ANIMAL_NAMES = { 'Penguin': 'ä¼éµ ğŸ§', 'Alpaca': 'ç¾Šé§ ğŸ¦™', 'Sloth': 'æ¨¹æ‡¶ ğŸ¦¥', 'Owl': 'è²“é ­é·¹ ğŸ¦‰', 'Sea Otter': 'æµ·çº ğŸ¦¦' };
        
        const FEATURE_DB = {
            shapes: ["é•·æ¢ç‹€çš„", "åœ“åœ“çš„", "æ–¹å½¢çš„", "ä¸‰è§’å½¢çš„", "æ˜Ÿæ˜Ÿåœ–æ¡ˆçš„", "å‹•ç‰©é€ å‹çš„", "æ‰å¹³çš„", "æ¾æ¾çš„", "å·¨å¤§çš„", "è¿·ä½ çš„", "æ„›å¿ƒåœ–æ¡ˆçš„"],
            colors: ["ç´…è‰²çš„", "é€æ˜çš„", "é»‘è‰²çš„", "ç¶ è‰²çš„", "æ·ºè‰²çš„", "æœ¨é ­è‰²çš„", "ç²‰å«©è‰²ç³»çš„",  "ç´”ç™½è‰²çš„", "äº”é¡å…­è‰²çš„"],
            functions: ["å¯ä»¥åƒçš„", "å¯ä»¥å–çš„", "æ‰‹æŒå¼çš„", "å¯ç©¿æˆ´çš„", "å¯ç©è€çš„", "æœƒå‹•çš„", "å¯ä»¥å……é›»çš„", "èˆ’å£“çš„", "å¯ä»¥ç”¨ä¾†è£é£¾çš„", "èˆ‡éŸ³æ¨‚æœ‰é—œçš„", "è®“ç”Ÿæ´»è®Šæ–¹ä¾¿çš„", "è¾¦å…¬å®¤å¯ç”¨çš„", "å¯ä»¥æ”¾åºŠä¸Šçš„", "æ¥è§¸è‚Œè†šçš„", "èˆ‡é£Ÿç‰©æœ‰é—œçš„", "å…·æ”¶ç´åŠŸèƒ½çš„", "å…·æ¸…æ½”åŠŸèƒ½çš„", "èˆ‡äº¤é€šæœ‰é—œçš„", "èˆ‡ç¡çœ æœ‰é—œçš„", "æ„Ÿè¦ºå¾ˆé¤Šç”Ÿçš„", "è·Ÿ3Cæœ‰é—œçš„"],
            states: ["é¦™é¦™çš„", "å†°å†·çš„", "äº®äº®çš„", "æœƒç™¼å‡ºè²éŸ³çš„", "æ¯›èŒ¸èŒ¸çš„", "é¹¹é¹¹çš„", "ç”œç”œçš„", "è¾£è¾£çš„", "ç†±ç†±çš„", "é˜²æ°´çš„", "ç£å¸çš„", "è»Ÿè»Ÿçš„", "ç¡¬é‚¦é‚¦çš„", "å¾ˆæœ‰é‡é‡çš„", "æ˜“ç¢çš„", "ç°¡ç´„é¢¨æ ¼çš„", "åœ¨å®¶æœƒç”¨åˆ°çš„", "æ¶²é«”ç‹€çš„", "å¯æ„›çš„", "åƒé˜¿muä¸€æ¨£èƒ–èƒ–çš„"]
        };

        let clientUUID = localStorage.getItem('clientUUID');
        if (!clientUUID) {
            clientUUID = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('clientUUID', clientUUID);
        }

        let currentUser = localStorage.getItem('animalUser'); 
        let myFeatures = [];
        let finalSelection = [];
        let isDrawing = false;
        let globalProfiles = {}; 

        // --- éŸ³æ•ˆç®¡ç† (ç¢ºä¿éŸ³æ•ˆä¸åŒ) ---
        const sounds = {
            drum: document.getElementById('sfx-drum-roll'), // ä½¿ç”¨é•·é¼“è²
            spin: document.getElementById('sfx-spin'),      // ä½¿ç”¨æ‹‰éœ¸è²
            tada: document.getElementById('sfx-tada'),      // ä½¿ç”¨æ…¶ç¥è²
            magic: document.getElementById('sfx-magic'),    // ä½¿ç”¨é­”æ³•è²
            click: document.getElementById('sfx-click')     // ä½¿ç”¨é»æ“Šè²
        };

        function playSfx(name) {
            const audio = sounds[name];
            if(audio) {
                audio.volume = (name === 'magic' || name === 'drum') ? 0.3 : 0.6; // èƒŒæ™¯éŸ³å°è²ä¸€é»ï¼ŒéŸ³æ•ˆå¤§è²ä¸€é»
                audio.currentTime = 0;
                audio.play().catch(e => console.log('Audio error:', e));
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!currentUser) {
                showSection('drawRoleSection');
                document.getElementById('wallSection').classList.add('hidden');
            }
            fetchData(); 
            setInterval(fetchData, 3000); 
        });

        // --- æ ¸å¿ƒæ›´æ–° ---
        function updateUIState(data) {
            document.getElementById('progressCount').innerText = data.submissionCount;
            const pct = Math.min((data.submissionCount/5)*100, 100);
            document.getElementById('progressBar').style.width = `${pct}%`;

            if (currentUser && !data.myRole) {
                console.log('Server reset detected.');
                localStorage.removeItem('animalUser');
                currentUser = null;
                showSection('drawRoleSection');
                document.getElementById('wallSection').classList.add('hidden');
                return;
            }

            if (!currentUser && data.myRole) {
                currentUser = data.myRole;
                localStorage.setItem('animalUser', currentUser);
            }

            globalProfiles = data.profiles || {};

            if (!currentUser) {
                showSection('drawRoleSection');
                document.getElementById('wallSection').classList.add('hidden'); 
                return;
            }

            document.getElementById('wallSection').classList.remove('hidden'); 
            document.querySelectorAll('.userBadgeText').forEach(el => el.innerText = ANIMAL_NAMES[currentUser]);

            const mySubmission = data.submissions[currentUser];
            const myProfile = data.profiles[currentUser];

            const currentVisible = document.querySelector('main > div:not(.hidden):not(#loading):not(#roleRevealSection):not(#wallSection):not(#pairingSection)');
            const currentId = currentVisible ? currentVisible.id : '';

            // é¿å…æ‰“æ–·é…å°å‹•ç•«
            if (!document.getElementById('pairingOverlay').classList.contains('hidden')) return;

            if (mySubmission && currentId !== 'submittedState') {
                document.getElementById('mySubmittedFeatures').innerText = `${mySubmission[0]} ï¼‹ ${mySubmission[1]}`;
                document.getElementById('mySubmittedName').innerText = myProfile ? myProfile.name : "(è³‡æ–™åŒæ­¥ä¸­)";
                showSection('submittedState');
            } 
            else if (myProfile && !mySubmission && currentId !== 'lotterySection') {
                showSection('lotterySection');
            } 
            else if (!myProfile && currentId !== 'profileSection' && currentId !== 'drawRoleSection') {
                showSection('profileSection');
            }

            const pWaiting = document.getElementById('pairingWaiting');
            const pAction = document.getElementById('pairingAction');
            const pResult = document.getElementById('pairingResult');

            if (data.isPaired) {
                pWaiting.classList.add('hidden');
                pAction.classList.add('hidden');
                
                if (pResult.classList.contains('hidden')) {
                    // åªåœ¨åˆæ¬¡é¡¯ç¤ºçµæœæ™‚æ’­æ”¾éŸ³æ•ˆ
                    playSfx('tada');
                    confetti({ particleCount: 200, spread: 100, origin: { y: 0.6 } });
                    pResult.classList.remove('hidden');
                    renderPairingResult(data.pairings); 
                }
            } else if (data.submissionCount >= 5) {
                pWaiting.classList.add('hidden');
                pAction.classList.remove('hidden');
                pResult.classList.add('hidden');
            } else {
                pWaiting.classList.remove('hidden');
                pAction.classList.add('hidden');
                pResult.classList.add('hidden');
            }
        }

        // --- æŠ½å–è§’è‰² ---
        function drawRole() {
            playSfx('click');
            const btn = document.getElementById('btnDrawRole');
            btn.disabled = true;
            btn.innerText = "ğŸ´ æ­£åœ¨æŠ½å‡º...";
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            const revealSec = document.getElementById('roleRevealSection');
            revealSec.classList.remove('hidden');
            
            // æ’­æ”¾é•·é¼“è²
            playSfx('drum'); 

            fetch(API_URL, {
                redirect: "follow", method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'draw_role', uuid: clientUUID })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success' && data.role) {
                    currentUser = data.role;
                    localStorage.setItem('animalUser', currentUser);
                    showRoleRevealResult(currentUser);
                } else {
                    alert('æŠ½å–å¤±æ•—: ' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
                    btn.disabled = false;
                    btn.innerText = "ğŸ´ æŠ½å–æˆ‘çš„è§’è‰²";
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    revealSec.classList.add('hidden');
                }
            })
            .catch(err => {
                alert('é€£ç·šéŒ¯èª¤');
                revealSec.classList.add('hidden');
                btn.disabled = false;
                btn.innerText = "ğŸ´ æŠ½å–æˆ‘çš„è§’è‰²";
                btn.classList.remove('opacity-50', 'cursor-not-allowed');
            });
        }

        function showRoleRevealResult(role) {
            const zhName = ANIMAL_NAMES[role];
            const cardContent = document.getElementById('cardContent');
            const revealCard = document.getElementById('revealCard');
            const revealTitle = document.getElementById('revealTitle');

            // ç¢ºä¿é¼“è²æ’­äº†ä¸€é™£å­å†æ­æ›‰ (è‡³å°‘ 2 ç§’)
            setTimeout(() => {
                // åœæ­¢é¼“è²ï¼Œæ’­æ”¾æˆåŠŸè²
                const drum = document.getElementById('sfx-drum-roll');
                if(drum) { drum.pause(); drum.currentTime = 0; }
                playSfx('tada');
                
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.5 } });
                
                revealCard.classList.remove('border-purple-400');
                revealCard.classList.add('border-yellow-400', 'scale-110'); 
                
                revealTitle.innerText = "ğŸ‰ è§’è‰²åˆ†é…å®Œæˆï¼";
                revealTitle.classList.remove('animate-pulse');

                cardContent.innerHTML = `
                    <div class="text-6xl mb-4 animate-bounce">${zhName.split(' ')[1]}</div>
                    <div class="text-3xl font-bold text-indigo-600">${zhName.split(' ')[0]}</div>
                `;
                document.getElementById('enterGameBtn').classList.remove('hidden');
            }, 2000); 
        }

        function confirmRole() {
            playSfx('click');
            document.getElementById('roleRevealSection').classList.add('hidden');
            document.querySelectorAll('.userBadgeText').forEach(el => el.innerText = ANIMAL_NAMES[currentUser]);
            showSection('profileSection'); 
            fetchData();
        }

        // --- é…å°æµç¨‹ ---
        function startPairingProcess() {
            if(!confirm("ç¢ºå®šè¦é€²è¡Œæœ€çµ‚é…å°å—ï¼Ÿ")) return;
            
            playSfx('magic'); // æ’­æ”¾æ‡¸ç–‘éŸ³æ•ˆ
            
            const overlay = document.getElementById('pairingOverlay');
            overlay.classList.remove('hidden');
            
            const shuffleText = document.getElementById('pairingShuffleText');
            const animalKeys = Object.keys(ANIMAL_NAMES);
            let shuffleInterval = setInterval(() => {
                const randomA = animalKeys[Math.floor(Math.random() * animalKeys.length)];
                const randomB = animalKeys[Math.floor(Math.random() * animalKeys.length)];
                shuffleText.innerText = `${ANIMAL_NAMES[randomA]} âœ ${ANIMAL_NAMES[randomB]}`;
            }, 100);

            fetch(API_URL, { 
                redirect: "follow", method: 'POST', 
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'generate_pair' }) 
            })
            .then(res => res.json())
            .then(data => {
                setTimeout(() => {
                    clearInterval(shuffleInterval);
                    overlay.classList.add('hidden');
                    
                    if(data.status === 'success' || data.status === 'already_paired') {
                        fetchData(); 
                    } else {
                        alert('é…å°å¤±æ•—ï¼š' + data.message);
                    }
                }, 3000); // è‡³å°‘è·‘3ç§’å‹•ç•«
            })
            .catch(err => {
                clearInterval(shuffleInterval);
                overlay.classList.add('hidden');
                alert("é€£ç·šéŒ¯èª¤");
            });
        }

        function showSection(sectionId) {
            const sections = ['drawRoleSection', 'profileSection', 'lotterySection', 'submittedState'];
            sections.forEach(id => {
                const el = document.getElementById(id);
                if (id === sectionId) el.classList.remove('hidden');
                else el.classList.add('hidden');
            });
        }

        function logout() {
            const pwd = prompt("ã€é–‹ç™¼è€…æ¨¡å¼ã€‘\nè«‹è¼¸å…¥å¯†ç¢¼ä¾†é‡ç½®èº«åˆ†ï¼š");
            if (pwd === "mumu") {
                localStorage.clear();
                const devRole = prompt("å¯†ç¢¼æ­£ç¢ºï¼\næŒ‡å®šè§’è‰²ä»£è™Ÿ ('Penguin', 'Alpaca', 'Sloth', 'Owl', 'Sea Otter')\n(ç•™ç©ºå‰‡å®Œå…¨é‡ç½®)");
                if (devRole) {
                    const formattedRole = devRole.charAt(0).toUpperCase() + devRole.slice(1).toLowerCase();
                    const validRoles = ['Penguin', 'Alpaca', 'Sloth', 'Owl', 'Sea Otter'];
                    if (validRoles.includes(formattedRole)) {
                        localStorage.setItem('animalUser', formattedRole);
                        localStorage.setItem('clientUUID', 'dev_test_' + Math.floor(Math.random() * 10000));
                        alert(`å·²åˆ‡æ›ç‚ºæ¸¬è©¦èº«åˆ†ï¼š${formattedRole}`);
                    } else {
                        alert("è§’è‰²ä»£è™ŸéŒ¯èª¤ï¼Œå°‡åŸ·è¡Œæ™®é€šé‡ç½®ã€‚");
                    }
                }
                location.reload();
            } else if (pwd !== null) {
                alert("å¯†ç¢¼éŒ¯èª¤ï¼");
            }
        }

        function submitProfile() {
            playSfx('click');
            const name = document.getElementById('inputName').value;
            if(!name) return alert('è«‹å¡«å¯«çœŸå¯¦å§“åï¼');

            const btn = document.getElementById('btnSubmitProfile');
            const originalText = btn.innerText;
            btn.innerText = "è³‡æ–™å„²å­˜ä¸­...";
            btn.disabled = true;
            btn.classList.add('opacity-50');

            fetch(API_URL, {
                redirect: "follow", method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'submit_profile', nickname: currentUser, realName: name })
            })
            .then(res => res.json())
            .then(data => {
                playSfx('tada');
                showSection('lotterySection');
                btn.innerText = originalText;
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            });
        }

        function submitFeatures() {
            playSfx('click');
            document.getElementById('loading').classList.remove('hidden');
            
            fetch(API_URL, {
                redirect: "follow", method: 'POST',
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify({ action: 'submit_feature', nickname: currentUser, feature1: finalSelection[0], feature2: finalSelection[1] })
            })
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                playSfx('tada');
                alert('è¨±é¡˜æˆåŠŸï¼ç¥ä½ è–èª•å¿«æ¨‚ï¼');
                fetchData();
            });
        }

        function fetchData() {
            const url = `${API_URL}?uuid=${clientUUID}`;
            fetch(url)
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').classList.add('hidden');
                renderWall(data.submissions);
                updateUIState(data);
            })
            .catch(err => console.error(err));
        }

        function renderWall(submissions) {
            const grid = document.getElementById('wallGrid');
            grid.innerHTML = '';
            ['Penguin', 'Alpaca', 'Sloth', 'Owl', 'Sea Otter'].forEach(engName => {
                const zhName = ANIMAL_NAMES[engName];
                const row = document.createElement('div');
                row.className = "bg-slate-700 bg-opacity-50 rounded p-3 flex items-center justify-between border border-slate-600";
                
                const nameDiv = document.createElement('div');
                nameDiv.innerHTML = `<span class="${engName === currentUser ? 'text-yellow-400 font-bold' : 'text-slate-200'}">${zhName}</span>`;
                const contentDiv = document.createElement('div');
                contentDiv.className = "flex gap-2";

                if (submissions[engName]) {
                    contentDiv.innerHTML = `
                        <span class="bg-red-600 text-white text-xs px-2 py-1 rounded shadow">${submissions[engName][0]}</span>
                        <span class="bg-green-600 text-white text-xs px-2 py-1 rounded shadow">${submissions[engName][1]}</span>
                    `;
                } else {
                    contentDiv.innerHTML = `<span class="text-slate-500 text-xs animate-pulse">æ€è€ƒä¸­...</span>`;
                }
                row.appendChild(nameDiv);
                row.appendChild(contentDiv);
                grid.appendChild(row);
            });
        }

        function renderPairingResult(pairings) {
            const container = document.getElementById('pairingResult');
            container.innerHTML = '';

            pairings.forEach((pair, index) => {
                const isMyMission = (pair.from === currentUser);
                const div = document.createElement('div');
                div.className = `p-3 rounded border flex flex-col ${isMyMission ? 'bg-yellow-900 bg-opacity-60 border-yellow-500 transform scale-105 shadow-xl' : 'bg-black bg-opacity-40 border-slate-700 opacity-70'}`;
                
                const basicInfo = `
                    <div class="flex items-center justify-between w-full">
                        <div class="font-bold text-slate-300 w-5/12 text-right ${pair.from===currentUser?'text-yellow-300':''}">${ANIMAL_NAMES[pair.from]}</div>
                        <div class="w-2/12 text-center text-red-500 text-xl">âœ</div>
                        <div class="font-bold text-slate-300 w-5/12 text-left ${pair.to===currentUser?'text-yellow-300':''}">${ANIMAL_NAMES[pair.to]}</div>
                    </div>
                `;
                div.innerHTML = basicInfo;

                if (isMyMission) {
                    const targetProfile = globalProfiles[pair.to];
                    const detailsDiv = document.createElement('div');
                    detailsDiv.className = "mt-3 pt-3 border-t border-yellow-500/30 text-left text-sm text-yellow-100";
                    if(targetProfile && targetProfile.name) {
                        detailsDiv.innerHTML = `
                            <p class="font-bold text-yellow-400 mb-1">ğŸ æ”¶ç¦®äººèº«åˆ†æ­æ›‰ï¼š</p>
                            <p class="text-xl text-white font-bold">${targetProfile.name}</p>
                        `;
                    } else {
                        detailsDiv.innerHTML = `<p class="text-red-400">âš ï¸ å°æ–¹å°šæœªå¡«å¯«å§“å</p>`;
                    }
                    div.appendChild(detailsDiv);
                }

                div.style.animation = `fadeIn 0.5s forwards ${index * 0.2}s`;
                container.appendChild(div);
            });
        }

        function startDrawAnimation() {
            if (isDrawing) return;
            isDrawing = true;
            document.getElementById('lotteryIntro').classList.add('hidden');
            document.getElementById('cardsContainer').classList.remove('hidden');
            playSfx('spin'); // æ’­æ”¾æ‹‰éœ¸è²

            const allFeaturesForAnim = [...FEATURE_DB.shapes, ...FEATURE_DB.colors, ...FEATURE_DB.functions, ...FEATURE_DB.states];
            const categories = Object.keys(FEATURE_DB);
            const selectedCategories = categories.sort(() => 0.5 - Math.random()).slice(0, 3);
            const finalDraw = selectedCategories.map(cat => {
                const list = FEATURE_DB[cat];
                return list[Math.floor(Math.random() * list.length)];
            });

            myFeatures = finalDraw;
            finalSelection = [...finalDraw];

            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';
            for(let i=0; i<3; i++) {
                const card = document.createElement('div');
                card.id = `slot-${i}`;
                card.className = "bg-gray-100 p-4 rounded-lg border-2 border-gray-300 text-center font-bold text-gray-400 text-xl";
                card.innerText = "???";
                container.appendChild(card);
            }

            let steps = 0;
            const interval = setInterval(() => {
                steps++;
                for(let i=0; i<3; i++) {
                    document.getElementById(`slot-${i}`).innerText = allFeaturesForAnim[Math.floor(Math.random() * allFeaturesForAnim.length)];
                }
                if (steps >= 20) {
                    clearInterval(interval);
                    revealFinalCards();
                }
            }, 100);
        }

        function revealFinalCards() {
            playSfx('tada'); // æ’­æ”¾æˆåŠŸè²
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
            renderCards();
            document.getElementById('submitBtn').classList.remove('hidden');
            const tip = document.createElement('p');
            tip.className = "text-center text-red-600 font-bold mt-2 animate-bounce";
            tip.innerText = "ğŸ‘‡ è«‹é»æ“Šã€Œåˆªé™¤ã€å»æ‰ 1 å€‹ç‰¹å¾µ";
            document.getElementById('cardsContainer').prepend(tip);
        }

        function renderCards() {
            const container = document.getElementById('cardsContainer');
            const tip = container.querySelector('p');
            container.innerHTML = '';
            if(tip) container.appendChild(tip);

            myFeatures.forEach((feature) => {
                const isDeleted = !finalSelection.includes(feature);
                const card = document.createElement('div');
                card.className = `p-4 rounded-lg border-2 flex justify-between items-center transition duration-300 ${isDeleted ? 'bg-gray-200 border-gray-300 opacity-60' : 'bg-red-50 border-red-300 scale-100'}`;
                
                const text = document.createElement('span');
                text.className = `font-bold text-lg ${isDeleted ? 'line-through text-gray-500' : 'text-red-700'}`;
                text.innerText = feature;

                const btn = document.createElement('button');
                btn.className = `text-sm px-3 py-1 rounded transition ${isDeleted ? 'bg-gray-500 text-white' : 'bg-red-500 text-white hover:bg-red-600 shadow'}`;
                btn.innerText = isDeleted ? "å¾©åŸ" : "åˆªé™¤ ğŸ—‘ï¸";
                btn.onclick = () => toggleFeature(feature);
                card.appendChild(text);
                card.appendChild(btn);
                container.appendChild(card);
            });
            updateSubmitBtn();
        }

        function toggleFeature(feature) {
            playSfx('click');
            if (finalSelection.includes(feature)) {
                if (finalSelection.length <= 2) finalSelection = finalSelection.filter(f => f !== feature);
                else finalSelection = finalSelection.filter(f => f !== feature);
            } else {
                if (finalSelection.length < 3) finalSelection.push(feature);
            }
            renderCards();
        }

        function updateSubmitBtn() {
            const btn = document.getElementById('submitBtn');
            if (finalSelection.length === 2) {
                btn.disabled = false;
                btn.className = "w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-lg transform transition hover:scale-105";
            } else {
                btn.disabled = true;
                btn.className = "w-full mt-6 bg-gray-400 text-white font-bold py-3 rounded-lg cursor-not-allowed";
            }
        }
    </script>
</body>
</html>
