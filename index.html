<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è–èª•å‹•ç‰©åŒ¿åäº¤æ›ç¦®ç‰© ğŸ„</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .snow-bg {
            background-color: #0f172a;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
        }
        .card-pop { animation: pop 0.3s ease-out forwards; }
        @keyframes pop { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
    </style>
</head>
<body class="snow-bg min-h-screen text-slate-100 pb-12">

    <!-- Header -->
    <header class="text-center py-8 px-4">
        <h1 class="text-4xl font-bold text-red-500 drop-shadow-md mb-2">ğŸ… è–èª•å‹•ç‰©ç¦®ç‰©äº¤æ› ğŸ</h1>
        <p class="text-slate-400">åŒ¿å Â· éš¨æ©Ÿç‰¹å¾µ Â· Coupang æ¡è³¼æŒ‘æˆ°</p>
    </header>

    <!-- Main Container -->
    <main class="max-w-md mx-auto px-4 relative">
        
        <!-- Loading Spinner (Hidden by default) -->
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-500"></div>
        </div>

        <!-- SECTION 1: Login -->
        <div id="loginSection" class="bg-white text-slate-800 rounded-xl p-6 shadow-xl border-4 border-green-700 mb-8">
            <h2 class="text-xl font-bold mb-4 text-center">ä½ æ˜¯å“ªéš»å‹•ç‰©ï¼Ÿ ğŸ¾</h2>
            <select id="animalSelect" class="w-full p-3 border rounded-lg mb-4 bg-slate-50">
                <option value="" disabled selected>è«‹é¸æ“‡ä½ çš„ä»£è™Ÿ</option>
                <option value="Penguin">Penguin (ä¼éµ)</option>
                <option value="Alpaca">Alpaca (ç¾Šé§)</option>
                <option value="Sloth">Sloth (æ¨¹æ‡¶)</option>
                <option value="Owl">Owl (è²“é ­é·¹)</option>
                <option value="Sea Otter">Sea Otter (æµ·çº)</option>
            </select>
            <button onclick="login()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition">
                é€²å…¥éŠæˆ²
            </button>
        </div>

        <!-- SECTION 2: Feature Lottery -->
        <div id="lotterySection" class="hidden bg-white text-slate-800 rounded-xl p-6 shadow-xl border-4 border-gold-500 mb-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-red-500 via-green-500 to-red-500"></div>
            <h2 class="text-xl font-bold mb-2 text-center text-green-800">âœ¨ ä½ çš„ç¦®ç‰©ç‰¹å¾µ âœ¨</h2>
            <p class="text-sm text-center text-gray-500 mb-4">ç³»çµ±éš¨æ©ŸæŠ½å‡º 3 å€‹ç‰¹å¾µï¼Œ<br>è«‹ <span class="text-red-600 font-bold">åˆªé™¤ 1 å€‹</span>ï¼Œä¿ç•™ 2 å€‹ä½œç‚ºæœ€çµ‚è¨±é¡˜ã€‚</p>

            <!-- Draw Button -->
            <div id="drawContainer" class="text-center py-4">
                <button onclick="drawFeatures()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105">
                    ğŸ² æŠ½å–æˆ‘çš„ç‰¹å¾µ
                </button>
            </div>

            <!-- Cards Container -->
            <div id="cardsContainer" class="grid grid-cols-1 gap-3 hidden">
                <!-- Cards will be injected here -->
            </div>

            <!-- Submit Button -->
            <button id="submitBtn" onclick="submitFeatures()" class="hidden w-full mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed">
                ğŸ ç¢ºèªä¸¦é€å‡ºé¡˜æœ›
            </button>
        </div>

        <!-- SECTION 3: The Wall -->
        <div id="wallSection" class="bg-slate-800 bg-opacity-80 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-slate-600 mb-8">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-yellow-400">ğŸ„ ç‰¹å¾µè¨±é¡˜ç‰†</h2>
                <button onclick="fetchData()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded">â†» åˆ·æ–°</button>
            </div>
            <div id="wallGrid" class="space-y-3">
                <!-- Wall Items injected here -->
                <p class="text-center text-slate-400">æ­£åœ¨è®€å–è³‡æ–™...</p>
            </div>
        </div>

        <!-- SECTION 4: Pairing -->
        <div id="pairingSection" class="bg-red-900 bg-opacity-80 backdrop-blur-sm rounded-xl p-6 shadow-xl border border-red-700">
            <h2 class="text-xl font-bold text-white mb-4 text-center">ğŸ”— ç¦®ç‰©é…å°éˆ</h2>
            <p class="text-xs text-center text-red-200 mb-4">é€™æ˜¯å…¬é–‹çš„é…å°çµæœï¼Œè«‹å°‡ç¦®ç‰©é€çµ¦ç®­é ­æŒ‡å‘çš„å‹•ç‰©ï¼</p>
            <div id="pairingList" class="space-y-2 text-center text-lg font-medium">
                <!-- Pairing Items injected here -->
            </div>
        </div>

    </main>

    <script>
        // ================= CONFIGURATION =================
        // è«‹åœ¨æ­¤è™•è²¼ä¸Š Google Apps Script éƒ¨ç½²å¾Œçš„ URL
        const API_URL = 'https://script.google.com/macros/s/AKfycbzq9VELc16iIDjvOvOPkcrvvBI6Wvz53KrnHIZJL5F-ivV6cvSP-C_PH8umKnaGcNBB5A/exec'; 
        // =================================================

        // Database of Features
        const FEATURE_DB = {
            shapes: ["é•·æ¢ç‹€çš„", "åœ“åœ“çš„", "æ–¹å½¢çš„", "ä¸è¦å‰‡å½¢ç‹€", "å½æ›²çš„"],
            colors: ["ç´…è‰²çš„", "é‡‘è‰²çš„", "é€æ˜çš„", "æ·±è‰²çš„", "æ·ºè‰²çš„", "éœ§é¢çš„"],
            functions: ["å¯ä»¥åƒçš„", "å¯ä»¥å–çš„", "æ‰‹æŒå¼çš„", "å¯ç©¿æˆ´çš„", "å¯ç©è€çš„"],
            states: ["é¦™é¦™çš„", "å†°å†·çš„", "æœƒç™¼å…‰çš„", "æœƒç™¼å‡ºè²éŸ³çš„", "æ¯›èŒ¸èŒ¸çš„"]
        };

        const ANIMALS = ['Penguin', 'Alpaca', 'Sloth', 'Owl', 'Sea Otter'];
        let myFeatures = []; // Stores the 3 drawn features
        let finalSelection = []; // Stores the 2 kept features
        let currentUser = localStorage.getItem('animalUser');

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            if (currentUser) {
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('lotterySection').classList.remove('hidden');
                document.getElementById('drawContainer').innerHTML = `<p class='text-green-700 font-bold'>å—¨ï¼Œ${currentUser}ï¼</p>`;
                checkStatus();
            }
            fetchData(); // Load wall and pairings initially
        });

        // --- Login Logic ---
        function login() {
            const select = document.getElementById('animalSelect');
            if (!select.value) return alert('è«‹é¸æ“‡ä¸€å€‹å‹•ç‰©ä»£è™Ÿï¼');
            
            currentUser = select.value;
            localStorage.setItem('animalUser', currentUser);
            
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('lotterySection').classList.remove('hidden');
            
            // Check if user already submitted before allowing to draw
            checkStatus();
        }

        // --- Check if user already submitted ---
        function checkStatus() {
            // Re-enable draw button if logic dictates, 
            // but for now, we wait for fetchData to see if we have data on server
        }

        // --- Lottery Logic ---
        function drawFeatures() {
            // Flatten DB
            const allFeatures = [
                ...FEATURE_DB.shapes,
                ...FEATURE_DB.colors,
                ...FEATURE_DB.functions,
                ...FEATURE_DB.states
            ];

            // Randomly select 3 unique
            let shuffled = allFeatures.sort(() => 0.5 - Math.random());
            myFeatures = shuffled.slice(0, 3);
            finalSelection = [...myFeatures]; // Initially keep all

            renderCards();
            
            // Hide draw button, show cards
            document.getElementById('drawContainer').classList.add('hidden');
            document.getElementById('cardsContainer').classList.remove('hidden');
            document.getElementById('submitBtn').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = true; // Must delete one first
            document.getElementById('submitBtn').innerText = "è«‹åˆªé™¤ 1 å€‹ç‰¹å¾µ";
        }

        function renderCards() {
            const container = document.getElementById('cardsContainer');
            container.innerHTML = '';

            myFeatures.forEach(feature => {
                const isDeleted = !finalSelection.includes(feature);
                
                const card = document.createElement('div');
                card.className = `p-4 rounded-lg border-2 flex justify-between items-center transition ${isDeleted ? 'bg-gray-200 border-gray-300 opacity-50' : 'bg-red-50 border-red-200'}`;
                
                const text = document.createElement('span');
                text.className = `font-bold ${isDeleted ? 'line-through text-gray-500' : 'text-red-700'}`;
                text.innerText = feature;

                const btn = document.createElement('button');
                btn.className = `text-xs px-3 py-1 rounded ${isDeleted ? 'bg-gray-400 text-white' : 'bg-red-500 text-white hover:bg-red-600'}`;
                btn.innerText = isDeleted ? "å¾©åŸ" : "åˆªé™¤";
                btn.onclick = () => toggleFeature(feature);

                card.appendChild(text);
                card.appendChild(btn);
                container.appendChild(card);
            });
        }

        function toggleFeature(feature) {
            if (finalSelection.includes(feature)) {
                // Remove it
                if (finalSelection.length <= 2) {
                    // Only allow deleting if we have 3 (logic is: must keep 2, so must delete 1)
                    // Wait, logic: Start with 3. Must delete 1 to get 2.
                    finalSelection = finalSelection.filter(f => f !== feature);
                } else {
                    // Already have 3, removing one to make it 2
                     finalSelection = finalSelection.filter(f => f !== feature);
                }
            } else {
                // Add it back
                if (finalSelection.length < 3) {
                    finalSelection.push(feature);
                }
            }
            
            renderCards();
            updateSubmitBtn();
        }

        function updateSubmitBtn() {
            const btn = document.getElementById('submitBtn');
            if (finalSelection.length === 2) {
                btn.disabled = false;
                btn.innerText = "ğŸ ç¢ºèªä¸¦é€å‡ºé¡˜æœ›";
                btn.classList.remove('bg-gray-400');
                btn.classList.add('bg-red-600');
            } else {
                btn.disabled = true;
                btn.innerText = `ç›®å‰ä¿ç•™ ${finalSelection.length} å€‹ (éœ€ä¿ç•™ 2 å€‹)`;
                btn.classList.add('bg-gray-400');
                btn.classList.remove('bg-red-600');
            }
        }

        // --- API Interaction ---
        function submitFeatures() {
            if (!currentUser) return;
            showLoading(true);

            const payload = {
                nickname: currentUser,
                feature1: finalSelection[0],
                feature2: finalSelection[1]
            };

            // Use 'no-cors' mode is tricky with POST in GAS sometimes, 
            // but text/plain body is usually handled best by the doPost(e) code provided.
            fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                showLoading(false);
                if(data.status === 'success') {
                    alert('è¨±é¡˜æˆåŠŸï¼');
                    document.getElementById('lotterySection').innerHTML = `<div class='text-center py-8'><h3 class='text-2xl text-green-700 font-bold'>ğŸ„ é¡˜æœ›å·²æ›ä¸Šæ¨¹æ¢¢ï¼</h3><p class='text-gray-500 mt-2'>è«‹æŸ¥çœ‹ä¸‹æ–¹çš„è¨±é¡˜ç‰†</p></div>`;
                    fetchData(); // Refresh wall
                } else {
                    alert('ç™¼ç”ŸéŒ¯èª¤: ' + data.message);
                }
            })
            .catch(err => {
                showLoading(false);
                console.error(err);
                alert('é€£ç·šéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
            });
        }

        function fetchData() {
            fetch(API_URL)
            .then(res => res.json())
            .then(data => {
                renderWall(data.submissions);
                renderPairings(data.pairings);
                
                // If current user already submitted, hide lottery logic
                if (currentUser && data.submissions[currentUser]) {
                     document.getElementById('lotterySection').innerHTML = `<div class='text-center py-8'><h3 class='text-2xl text-green-700 font-bold'>ğŸ„ é¡˜æœ›å·²æ›ä¸Šæ¨¹æ¢¢ï¼</h3><p class='text-gray-500 mt-2'>ä½ çš„é¡˜æœ›ï¼š${data.submissions[currentUser][0]} + ${data.submissions[currentUser][1]}</p></div>`;
                }
            })
            .catch(err => console.error('Fetch error:', err));
        }

        // --- Rendering Wall & Pairings ---
        function renderWall(submissions) {
            const grid = document.getElementById('wallGrid');
            grid.innerHTML = '';

            ANIMALS.forEach(animal => {
                const row = document.createElement('div');
                row.className = "bg-slate-700 rounded p-3 flex items-center justify-between border border-slate-600";
                
                const nameSpan = document.createElement('span');
                nameSpan.className = "font-bold text-yellow-400 w-1/3";
                nameSpan.innerText = animal + (animal === currentUser ? " (ä½ )" : "");

                const contentDiv = document.createElement('div');
                contentDiv.className = "flex gap-2 w-2/3 justify-end";

                if (submissions[animal]) {
                    // Has data
                    const f1 = document.createElement('span');
                    f1.className = "bg-red-600 text-white text-xs px-2 py-1 rounded shadow";
                    f1.innerText = submissions[animal][0];
                    
                    const f2 = document.createElement('span');
                    f2.className = "bg-green-600 text-white text-xs px-2 py-1 rounded shadow";
                    f2.innerText = submissions[animal][1];

                    contentDiv.appendChild(f1);
                    contentDiv.appendChild(f2);
                } else {
                    // Waiting
                    contentDiv.innerHTML = `<span class="text-slate-500 text-sm italic">ç­‰å¾…è¨±é¡˜ä¸­...</span>`;
                }

                row.appendChild(nameSpan);
                row.appendChild(contentDiv);
                grid.appendChild(row);
            });
        }

        function renderPairings(pairings) {
            const container = document.getElementById('pairingList');
            container.innerHTML = '';
            
            if (!pairings || pairings.length === 0) {
                container.innerHTML = '<p class="text-gray-400">é…å°ç”Ÿæˆä¸­...</p>';
                return;
            }

            pairings.forEach(pair => {
                const div = document.createElement('div');
                div.className = "bg-black bg-opacity-30 p-2 rounded text-red-100 flex justify-center items-center gap-2";
                
                // Highlight if current user is involved
                let fromStyle = pair.from === currentUser ? "text-yellow-300 font-bold underline" : "";
                let toStyle = pair.to === currentUser ? "text-yellow-300 font-bold underline" : "";

                div.innerHTML = `<span class="${fromStyle}">${pair.from}</span> <span class="text-xs text-gray-400">é€çµ¦ âœ</span> <span class="${toStyle}">${pair.to}</span>`;
                container.appendChild(div);
            });
        }

        function showLoading(show) {
            const el = document.getElementById('loading');
            if(show) el.classList.remove('hidden');
            else el.classList.add('hidden');
        }
    </script>
</body>
</html>
