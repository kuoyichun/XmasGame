<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎄 2025聖誕神秘交換禮物</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- 3. 特效庫 -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- 4. 關鍵修復：強制定義 hidden 樣式，防止排版崩壞 -->
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        /* 即使 Tailwind 載入失敗，這個樣式也能確保頁面邏輯正常 */
        .hidden { display: none !important; }
        
        .snow-bg {
            background-color: #0f172a;
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 40L40 0H20L0 20M40 40V20L20 40'/%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="snow-bg min-h-screen text-slate-100 pb-20 relative">

    <!-- 音效區 -->
    <audio id="sfx-spin" src="https://assets.mixkit.co/active_storage/sfx/2003/2003-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>
    <audio id="sfx-drum" src="https://assets.mixkit.co/active_storage/sfx/2000/2000-preview.mp3"></audio>
    <audio id="sfx-tada" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3"></audio>

    <!-- 重置按鈕 -->
    <button onclick="logout()" class="absolute top-4 left-4 text-xs text-slate-500 hover:text-white border border-slate-600 px-2 py-1 rounded z-50">🔒 重置</button>

    <header class="text-center py-8 px-4 mt-4">
        <h1 class="text-4xl font-bold text-red-500 drop-shadow-md mb-2">🎅 2025聖誕神秘交換禮物</h1>
        <p class="text-slate-400 text-sm">抽取角色  · 命運配對</p>
    </header>

    <main class="max-w-md mx-auto px-4 relative">
        <!-- Loading 遮罩 -->
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-500 mb-4"></div>
            <p class="text-white font-bold" id="loadingText">處理中...</p>
        </div>

        <!-- 0. 抽取角色區 (取代舊版準備室) -->
        <div id="drawRoleSection" class="hidden bg-white text-slate-800 rounded-xl p-6 shadow-xl border-4 border-purple-600 mb-8 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-full bg-purple-50 opacity-50 pointer-events-none"></div>
            <h2 class="text-2xl font-bold mb-4 text-center text-purple-900 relative z-10">🎭 你的神秘身分是？</h2>
            <div class="text-center py-4 relative z-10">
                <div class="text-6xl mb-6">❓</div>
                <p class="text-gray-500 mb-6 text-sm">點擊按鈕，從命運牌堆中<br>抽取一張專屬於你的動物卡牌。</p>
                <button onclick="drawRole()" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold py-4 rounded-xl shadow-lg text-lg transform transition hover:scale-105 active:scale-95">
                    🎴 抽取我的角色
                </button>
            </div>
        </div>

        <!-- 0.5 角色揭曉動畫區 (預設隱藏) -->
        <div id="roleRevealSection" class="hidden fixed inset-0 z-40 bg-slate-900 flex flex-col items-center justify-center text-center px-4">
            <h2 class="text-white text-2xl font-bold mb-4">🎉 命運決定了！</h2>
            <p class="text-gray-300 mb-6">你的身分是...</p>
            <div id="revealCard" class="bg-white text-slate-900 p-8 rounded-2xl shadow-2xl transform scale-0 transition-all duration-700 w-64 h-80 flex flex-col items-center justify-center border-4 border-yellow-400">
                <div class="text-6xl mb-4">❓</div>
            </div>
            <button onclick="confirmRole()" class="mt-10 bg-yellow-500 hover:bg-yellow-600 text-white px-10 py-3 rounded-full font-bold shadow-lg hidden animate-bounce" id="enterGameBtn">
                進入遊戲 ➜
            </button>
        </div>

        <!-- 1.5 真實姓名填寫 -->
        <div id="profileSection" class="hidden bg-white text-slate-800 rounded-xl p-6 shadow-xl border-4 border-blue-600 mb-8">
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-blue-600 text-white px-4 py-1 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">
                身分：<span class="userBadgeText"></span>
            </div>
            <h2 class="text-xl font-bold mb-2 text-center text-blue-800 mt-4">📛 填寫真實姓名</h2>
            <p class="text-sm text-gray-500 text-center mb-4">讓抽到你的人知道是誰！</p>
            <div class="space-y-3">
                <input type="text" id="inputName" placeholder="請輸入你的真實姓名" class="w-full p-4 border-2 border-blue-200 rounded-xl text-lg text-center font-bold">
                <button onclick="submitProfile()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg text-lg">確認儲存 & 下一步</button>
            </div>
        </div>

        <!-- 2. 抽籤區 -->
        <div id="lotterySection" class="hidden bg-white text-slate-800 rounded-xl p-6 shadow-xl border-4 border-yellow-500 mb-8 relative">
            <div class="absolute -top-3 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-white px-4 py-1 rounded-full text-sm font-bold shadow-sm whitespace-nowrap">
                身分：<span class="userBadgeText"></span>
            </div>
            <h2 class="text-xl font-bold mb-2 text-center text-yellow-800 mt-4">✨ 抽取禮物特徵 ✨</h2>
            <div id="lotteryIntro">
                <p class="text-sm text-center text-gray-500 mb-6">系統將從資料庫隨機抽出 3 個特徵。</p>
                <button onclick="startDrawAnimation()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-4 rounded-xl shadow-lg text-lg">🎰 啟動拉霸機</button>
            </div>
            <div id="cardsContainer" class="grid grid-cols-1 gap-3 hidden mt-4"></div>
            <button id="submitBtn" onclick="submitFeatures()" class="hidden w-full mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg shadow-lg disabled:bg-gray-400">🎁 確認並送出願望</b
